<%
# View which displays a list of all the users under an instance,
# specified by @instance.  
#
# Author::      Eli Fox-Epstein, efoxepstein@wesleyan.edu
# Author::      Dimitar Gochev, dimitar.gochev@trincoll.edu
# Copyright::   Humanitarian FOSS Project (http://www.hfoss.org), Copyright (C) 2009.
# License::     http://www.gnu.org/copyleft/lesser.html GNU Lesser General Public License (LGPL)
%>

<% content_for :title, title('Contacts', @instance.short_name)%>
<% content_for :javascripts, javascript_include_tag('jquery','users')%>

<% content_for :breadcrumbs, 
	breadcrumbs(['Contacts',users_path]) %>
<% content_for :subheader_title do %>
	<% if @search and @groups_filter %>
		<%="Results for '#{h @search}' in #{h @instance.groups.find(@groups_filter).name}" %>
	<% elsif @groups_filter %>
		<%= "Results in #{h @instance.groups.find(@groups_filter).name}" %>
	<% elsif @search %>
		<%= "Results for '#{h @search}'" %>
	<% else %>
		All Contacts
	<% end %>
<% end %>
<% content_for :buttons do %>
	<%= link_to 'Download these contacts', vcards_path('contacts', :users =>(@users.map {|u|u.id}).join(',')), :class => 'button-link' %>
    <%= mail_to (@users.map {|u| u.email}).join(';'), 'Email these contacts', :class => 'button-link', :target => '_blank' %>
<% end %>
<% content_for :filters do %>
	<%
		groups = @instance.groups.reject {|g| g.memberships.length == 0 }
		groups_options = options_for_select([['All Groups', '']] + groups.map{|g| [g.name, g.id]}, @groups_filter.to_i )
		states_options = options_for_select([['Active', 'active'], ['Pending','pending_approval']], @states_filter)
	%>

	<% form_tag users_path, :method => :get do %>
		<%= text_field_tag :search, (params[:search] || 'Search Keywords'), :size => 20, :class=>(!params[:search] || params[:search] == '' ? 'blank':'') %>
		<%= select_tag(:groups_filter, groups_options, :id => 'filters_groups') %>
		<%= select_tag(:states_filter, states_options, :id => 'filters_states') if @states_filter %>
		<%= submit_tag "Apply Filters", :name => nil, :id => 'filters_submit' %>
	<% end %>
<% end %>


<% content_for :body do %>

	<ul id="index">
		<li><em>Jump to last name:</em></li>
	<%  letters = []
	    @users.each {|u| letters << u.last_name[0,1] unless letters.include?(u.last_name[0,1])}
	%>
	
	<% ('A'..'Z').each do |l| %>
		<li><a href="#<%=l%>" class="<%="bold" if letters.include?(l)%>"><%=l%></a></li>	
	<% end %>
	</ul>

	<% if @users.size == 0 %>
		<h3 class="centered">
			Sorry, no contacts match your search or filters.
		</h3>
	<% end %>
	<ul id="contacts">
	<% 	last = ''
		@users.each do |u|
			if u.last_name[0,1].upcase != last
				last = u.last_name[0,1].upcase
			%>
				<li class="separator" id="<%=last%>"><%=last%></li>
			<% end %>
		<li>
			<div class="name">
				<%= link_to u.last_first, u %>
				<span class="vcard"><%=link_to 'vCard', user_path(u, :format => :vcf) -%></span></div>
			<div class="person-info">
				<% if u.state != 'active' && u.updatable_by?(@current_user) %>
					<span>
						<%= link_to 'Approve', user_path(u, :user => {:state => :active}), {:method => :put} %>
					</span>
				<% end %>
				<% if u.cell_phone? %>
					<span class="phone">
						<span class="contact-label">cell phone:</span>
						<%=phone u.cell_phone %> <%= preferred if u.preferred_is_cell? and u.desk_phone? %>
					</span>
				<% end %>
				<% if u.desk_phone? %>
					<span class="phone">
						<span class="contact-label">desk phone:</span>
						<%=phone u.desk_phone_with_ext %> <%= preferred if !u.preferred_is_cell and u.cell_phone? %>
					</span>
				<% end %>
				<% if u.email %>
					<span class="email">
						<span class="contact-label">email:</span>
						<%=mail_to u.email, u.email, :target => '_blank' %>
					</span>
				<% end %>
				<% if u.groups and u.groups.length > 0 %>
					<div class="groups-container">
						<span class="contact-label">groups:</span>
						<ul class="groups">
						<% if u.groups.length > 4 %>
							<% u.groups[0,4].each do |g| %>
							<li><%= link_to g.name, group_type_group_path(g.group_type, g) %></li>
							<% end %>
							<li class="more"><%= link_to "["+(u.groups.length-4).to_s+"&nbsp;more]", u%></li>
						<% else %>
							<% u.groups.each do |g| %>
							<li><%= link_to g.name, group_type_group_path(g.group_type, g) %></li>
							<% end %>
						<% end %>
						</ul>
					</div>
				<% end %>
			</div>
		</li>
	<% end %>
	</ul>
	<div style="clear:both"></div>
	<%= will_paginate @users %>
<% end %>
