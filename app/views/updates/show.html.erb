<%
# View which displays a single update's information.  
#
# Author::      Eli Fox-Epstein, efoxepstein@wesleyan.edu
# Author::      Dimitar Gochev, dimitar.gochev@trincoll.edu
# Copyright::   Humanitarian FOSS Project (http://www.hfoss.org), Copyright (C) 2009.
# License::     http://www.gnu.org/copyleft/lesser.html GNU Lesser General Public License (LGPL)
%>

<% content_for :title, title(@update.title, 'Update', @incident.name, 'Incidents', @instance.short_name)%>

<% content_for :breadcrumbs, 
	breadcrumbs(['Incidents',incidents_path],
				[@incident.name,incident_path(@incident)]) %>
<% content_for :subheader_title, @update.title %>
<% content_for :buttons do %>
	<%= pretty_button(:delete_update, incident_update_path(@incident, @update), 'Delete Update', :method => :delete, :confirm => "Really delete update?") if can?(:destroy => @update)%>
	<%= pretty_button(:edit_update, edit_incident_update_path(@incident, @update), 'Edit Update') if can?(:update => @update) %>
<% end %>
<% content_for :subheader_text,
	subheader_text('by '+link_to_issuer(@update)+' on '+time_mdy(@update.created_at)) %>

<% content_for :body do %>
  <p><%=simple_format(h(@update.text)) %></p>
  <div class="comments">
    <% @update.comments.each do |c| %>
    <div class="comment">
      <span class="comment-author"><%=link_to c.user.full_name, c.user %></span>
      <span class="comment-body"><%=c.body%></span>
      <span class="comment-date">posted <%=time_ago_in_words c.created_at%> ago</span>
    </div>
    <% end %>
    <% form_for [@update.incident, @update, Comment.new] do |f| %>
      <%= f.text_field :body, :class => "comment-textfield" %>
      <%= f.submit 'Add Comment', :class => "comment-submit" %>
      <div class="clear"></div>
    <% end %>
  </div>
  <div id="extra">
  <!-- Files-->
    <% unless @update.file_urls.empty? %>
      <div id="files">
        <h3>Pictures:</h3>
        <ul>
        <% @update.attached_files.each do |f| %>
            <% if f.attach.original_filename =~ /(jpg)|(png)|(gif)/ %>
                <% w, h = FastImage.size(f.attach.path) %>
                <li><%=link_to(image_tag(f.attach.url, :size => scale_dimensions(w, h, 200).join('x')), f.attach.url)%></li>
            <% else %>
              <li><%=link_to(f.attach.original_filename, f.attach.url)%></li>
          <% end %>
        <% end %>
        </ul>
        <h3>Other Files</h3>
      </div>
    <% end %>

    <!-- Groups -->
    <% unless @update.tags.empty? %>
      <div id="relevant-groups">
        <h3>Relevant Groups:</h3>
        <ul>
        <% @update.relevant_groups.each do |g| %>
          <li><%=easy_link_to(g.name, g)%></li>
        <% end %>
        </ul>
      </div>
    <% end %>
        
    <!-- Tags -->
    <% unless @update.tags.empty? %>
      <div id="tags">
        <h3>Tags:</h3>
        <ul>
        <% @update.tags.each do |t| %>
          <li><%=easy_link_to(t.name, t)%></li>
        <% end %>
        </ul>
      </div>
    <% end %>
  </div>
<% end %>
